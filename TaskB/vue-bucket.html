<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New-Vue</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.js"
      integrity="sha512-w39cIBZHEf0ac8RERRGs+aTrQbBIpb+0qGsMCKfwvJSmN6YV8brsbYN1a/nTmuQgfrGyg7p3WI4HRu1rs3rLvw=="
      crossorigin="anonymous"
    ></script>
    <style>
      * {
        font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
      }
      canvas {
        border: 1px solid #000;
      }
    </style>
  </head>
  <body>
    <div id="app">
      現在顏色{{colorString}}
      <button @click="color = [200,0,0,255]">change red</button>
      <button @click="color = [0,255,255,255]">change blue</button>
      <button @click="mode = mode === 'pen' ? 'bucket' : 'pen' ">
        toggle　{{mode}}
      </button>
      <div
        style="width: 50px; height: 50px"
        :style="{background:colorString}"
      ></div>
      <canvas
        ref="cvs"
        @mousedown="mouseDown"
        @mousemove="mouseMove"
        @mouseup="mouseUp"
      ></canvas>
    </div>
    <script>
      const app = Vue.createApp({
        data() {
          return {
            mode: "pen",
            color: [0, 0, 0, 255],
            colorString: "rgba(0,0,0,255)",
            ctx: null,
            ctxFlag: false,
          };
        },
        mounted() {
          this.ctx = this.$refs.cvs.getContext("2d");
          this.ctx.lineWidth = 20;
          this.ctx.lineJoin = "round";
          this.ctx.lineCap = "round";
        },
        watch: {
          color([r, g, b, a]) {
            this.colorString = `rgba(${r},${g},${b},${a})`;
          },
        },
        methods: {
          mouseDown(e) {
            console.log("mouseDown", e);
            const penX = e.offsetX;
            const penY = e.offsetY;

            if (this.mode === "bucket") {
              const newColor = this.color;
              const baseImageData = this.ctx.getImageData(penX, penY, 1, 1);
              const baseColor = baseImageData.data;

              const imageData = this.ctx.getImageData(
                0,
                0,
                this.ctx.canvas.width,
                this.ctx.canvas.height
              );
              const pixels = imageData.data;
              const list = [[penX, penY]];

              while (list.length) {
                const [x, y] = list.shift();
                const startIndex = (y * this.ctx.canvas.width + x) * 4;
                if (baseColor.every((x, i) => pixels[startIndex + i] === x)) {
                  for (let i = 0; i < 4; i++) {
                    pixels[startIndex + i] = newColor[i];
                  }
                  list.push([x + 1, y]);
                  list.push([x - 1, y]);
                  list.push([x, y + 1]);
                  list.push([x, y - 1]);
                }
              }
              this.ctx.putImageData(imageData, 0, 0);

              return;
            }
            this.ctxFlag = true;
            this.ctx.beginPath();
            this.ctx.moveTo(e.offsetX, e.offsetY);
            this.ctx.strokeStyle = this.colorString;
          },
          mouseMove(e) {
            if (!this.ctxFlag) return;
            this.ctx.lineTo(e.offsetX, e.offsetY);
            this.ctx.stroke();
            console.log("mouseMove", e);
          },
          mouseUp(e) {
            console.log("mouseUp", e);
            this.ctx.closePath();
            this.ctxFlag = false;
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
